<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subir Informe - NeuroPlan</title>
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 600px;
      width: 100%;
    }
    
    h1 { 
      color: #667eea; 
      margin-bottom: 10px;
      font-size: 32px;
    }
    
    .subtitle {
      color: #666; 
      margin-bottom: 30px;
      font-size: 16px;
    }
    
    label { 
      display: block; 
      margin: 20px 0 8px; 
      font-weight: bold;
      color: #333;
    }
    
    select, input[type="file"], input[type="text"], input[type="email"], input[type="date"] { 
      width: 100%; 
      padding: 12px; 
      border: 2px solid #ddd; 
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    select:focus, input[type="file"]:focus, input[type="text"]:focus, input[type="email"]:focus, input[type="date"]:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .file-info {
      display: block;
      margin-top: 5px;
      font-size: 12px;
      color: #999;
    }
    
    button {
      width: 100%;
      padding: 15px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
      transition: all 0.3s;
    }
    
    button:hover { 
      background: #764ba2; 
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    button:disabled { 
      background: #ccc; 
      cursor: not-allowed; 
      transform: none;
    }
    
    .progress {
      display: none;
      background: #f8f9fa;
      padding: 30px;
      border-radius: 10px;
      margin-top: 20px;
      text-align: center;
    }
    
    .progress.show { 
      display: block; 
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .progress-text {
      color: #667eea;
      font-size: 16px;
      font-weight: bold;
      margin-top: 15px;
    }
    
    .progress-steps {
      text-align: left;
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
    }
    
    .step {
      display: flex;
      align-items: center;
      padding: 8px 0;
      color: #666;
    }
    
    .step.active {
      color: #667eea;
      font-weight: bold;
    }
    
    .step.done {
      color: #28a745;
    }
    
    .step-icon {
      margin-right: 10px;
      font-size: 20px;
    }
    
    .result {
      display: none;
      background: #d4edda;
      border: 2px solid #28a745;
      padding: 30px;
      border-radius: 10px;
      margin-top: 20px;
    }
    
    .result.show { 
      display: block; 
    }
    
    .result h3 { 
      color: #28a745; 
      margin-bottom: 15px;
      font-size: 24px;
    }
    
    .result-info {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    
    .result-info p {
      margin: 8px 0;
      color: #333;
    }
    
    .result-info strong {
      color: #667eea;
    }
    
    .btn-secondary {
      background: #28a745;
      margin-top: 15px;
    }
    
    .btn-secondary:hover {
      background: #218838;
    }
    
    .error {
      display: none;
      background: #f8d7da;
      border: 2px solid #dc3545;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      color: #721c24;
    }
    
    .error.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìÑ NeuroPlan</h1>
    <p class="subtitle">Sube un informe y genera un PEI completo en 30 segundos con Claude AI</p>

    <form id="uploadForm">
      <div style="margin-bottom: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px;">
        <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
          <input type="checkbox" id="newStudent" style="width: auto; margin-right: 10px;">
          <span style="font-weight: normal;">‚ûï Crear nuevo estudiante</span>
        </label>
      </div>

      <!-- Selector de estudiante existente -->
      <div id="existingStudentSection">
        <label for="studentId">Estudiante:</label>
        <select id="studentId">
          <option value="">Cargando estudiantes...</option>
        </select>
      </div>

      <!-- Formulario para nuevo estudiante -->
      <div id="newStudentSection" style="display: none;">
        <label for="studentName">Nombre:</label>
        <input type="text" id="studentName" placeholder="Ej: Mar√≠a">

        <label for="studentLastName">Apellidos:</label>
        <input type="text" id="studentLastName" placeholder="Ej: Garc√≠a L√≥pez">

        <label for="studentBirthDate">Fecha de Nacimiento:</label>
        <input type="date" id="studentBirthDate">

        <label for="studentGrade">Curso:</label>
        <select id="studentGrade">
          <option value="">Seleccionar curso...</option>
          <option value="1¬∫ Infantil">1¬∫ Infantil</option>
          <option value="2¬∫ Infantil">2¬∫ Infantil</option>
          <option value="3¬∫ Infantil">3¬∫ Infantil</option>
          <option value="1¬∫ Primaria">1¬∫ Primaria</option>
          <option value="2¬∫ Primaria">2¬∫ Primaria</option>
          <option value="3¬∫ Primaria">3¬∫ Primaria</option>
          <option value="4¬∫ Primaria">4¬∫ Primaria</option>
          <option value="5¬∫ Primaria">5¬∫ Primaria</option>
          <option value="6¬∫ Primaria">6¬∫ Primaria</option>
          <option value="1¬∫ ESO">1¬∫ ESO</option>
          <option value="2¬∫ ESO">2¬∫ ESO</option>
          <option value="3¬∫ ESO">3¬∫ ESO</option>
          <option value="4¬∫ ESO">4¬∫ ESO</option>
          <option value="1¬∫ Bachillerato">1¬∫ Bachillerato</option>
          <option value="2¬∫ Bachillerato">2¬∫ Bachillerato</option>
        </select>

        <label for="studentParentEmail">Email de contacto:</label>
        <input type="email" id="studentParentEmail" placeholder="familia@email.com">
      </div>

      <label for="file" style="margin-top: 20px;">Informe (PDF, Word, Imagen):</label>
      <input type="file" id="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt" required>
      <span class="file-info">M√°ximo 10MB - Formatos: PDF, DOC, DOCX, JPG, PNG, TXT</span>

      <button type="submit" id="submitBtn">üöÄ Subir y Generar PEI</button>
    </form>

    <div id="progress" class="progress">
      <div class="spinner"></div>
      <p class="progress-text" id="progressText">Procesando...</p>
      
      <div class="progress-steps">
        <div class="step" id="step1">
          <span class="step-icon">‚è≥</span>
          <span>Subiendo archivo...</span>
        </div>
        <div class="step" id="step2">
          <span class="step-icon">üìÑ</span>
          <span>Extrayendo texto del documento...</span>
        </div>
        <div class="step" id="step3">
          <span class="step-icon">ü§ñ</span>
          <span>Analizando con Claude AI...</span>
        </div>
        <div class="step" id="step4">
          <span class="step-icon">üìã</span>
          <span>Generando objetivos y adaptaciones...</span>
        </div>
        <div class="step" id="step5">
          <span class="step-icon">üìß</span>
          <span>Enviando notificaciones...</span>
        </div>
      </div>
    </div>

    <div id="result" class="result">
      <h3>‚úÖ ¬°PEI Generado Exitosamente!</h3>
      <div class="result-info">
        <p><strong>ID del PEI:</strong> <span id="peiId"></span></p>
        <p><strong>Estudiante:</strong> <span id="studentName"></span></p>
        <p><strong>Estado:</strong> <span id="peiStatus">DRAFT</span></p>
        <p><strong>Versi√≥n:</strong> <span id="peiVersion">1</span></p>
      </div>
      <p style="margin: 15px 0; color: #155724;">
        üìß La familia ha recibido un email con el resumen del PEI<br>
        üì± El coordinador ha sido notificado<br>
        üìÖ Revisi√≥n programada en 3 meses
      </p>
      <button onclick="window.location.reload()" class="btn-secondary">
        Generar otro PEI
      </button>
    </div>

    <div id="error" class="error">
      <h3>‚ùå Error</h3>
      <p id="errorMessage"></p>
      <button onclick="window.location.reload()" style="background: #dc3545; margin-top: 10px;">
        Intentar de nuevo
      </button>
    </div>
  </div>

  <script>
    // Probar ambas URLs (localhost y 127.0.0.1)
    const API_URLS = ['http://localhost:3001', 'http://127.0.0.1:3001'];
    let API_URL = API_URLS[0];

    // Cargar estudiantes al iniciar
    document.addEventListener('DOMContentLoaded', async () => {
      // Probar conectividad primero
      await testConnection();
      await loadStudents();
      
      // Manejar checkbox de nuevo estudiante
      document.getElementById('newStudent').addEventListener('change', function() {
        const existingSection = document.getElementById('existingStudentSection');
        const newSection = document.getElementById('newStudentSection');
        const studentSelect = document.getElementById('studentId');
        
        if (this.checked) {
          existingSection.style.display = 'none';
          newSection.style.display = 'block';
          studentSelect.removeAttribute('required');
          document.getElementById('studentName').setAttribute('required', 'required');
          document.getElementById('studentLastName').setAttribute('required', 'required');
          document.getElementById('studentBirthDate').setAttribute('required', 'required');
          document.getElementById('studentGrade').setAttribute('required', 'required');
          document.getElementById('studentParentEmail').setAttribute('required', 'required');
        } else {
          existingSection.style.display = 'block';
          newSection.style.display = 'none';
          studentSelect.setAttribute('required', 'required');
          document.getElementById('studentName').removeAttribute('required');
          document.getElementById('studentLastName').removeAttribute('required');
          document.getElementById('studentBirthDate').removeAttribute('required');
          document.getElementById('studentGrade').removeAttribute('required');
          document.getElementById('studentParentEmail').removeAttribute('required');
        }
      });
    });

    // Probar conexi√≥n con el backend
    async function testConnection() {
      for (const url of API_URLS) {
        try {
          const response = await fetch(`${url}/health`, { 
            method: 'GET',
            signal: AbortSignal.timeout(3000) // 3 segundos timeout
          });
          if (response.ok) {
            API_URL = url;
            console.log(`‚úÖ Backend conectado en: ${API_URL}`);
            return true;
          }
        } catch (error) {
          console.warn(`‚ùå No se pudo conectar a ${url}:`, error.message);
        }
      }
      showError('No se puede conectar al backend. ¬øEst√° corriendo en el puerto 3001?');
      return false;
    }

    // Cargar lista de estudiantes
    async function loadStudents() {
      try {
        const response = await fetch(`${API_URL}/api/uploads/students`);
        const students = await response.json();

        const select = document.getElementById('studentId');
        select.innerHTML = '<option value="">Seleccionar estudiante...</option>';
        
        students.forEach(student => {
          const option = document.createElement('option');
          option.value = student.id;
          option.textContent = `${student.name} ${student.lastName} - ${student.grade}`;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error cargando estudiantes:', error);
        const select = document.getElementById('studentId');
        select.innerHTML = '<option value="cmgmtmx5m0000tbr67zc8hg9m">Ana P√©rez - 5¬∫ Primaria</option>';
      }
    }

    // Manejar submit del formulario
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const form = document.getElementById('uploadForm');
      const progress = document.getElementById('progress');
      const result = document.getElementById('result');
      const error = document.getElementById('error');
      const file = document.getElementById('file').files[0];
      const isNewStudent = document.getElementById('newStudent').checked;

      if (!file) {
        showError('Por favor selecciona un archivo');
        return;
      }

      let studentId;

      // Ocultar todo y mostrar progreso
      form.style.display = 'none';
      result.classList.remove('show');
      error.classList.remove('show');
      progress.classList.add('show');

      try {
        // Si es nuevo estudiante, crearlo primero
        if (isNewStudent) {
          const studentData = {
            name: document.getElementById('studentName').value,
            lastName: document.getElementById('studentLastName').value,
            birthDate: document.getElementById('studentBirthDate').value,
            grade: document.getElementById('studentGrade').value,
            parentEmail: document.getElementById('studentParentEmail').value,
          };

          if (!studentData.name || !studentData.lastName || !studentData.birthDate || !studentData.grade || !studentData.parentEmail) {
            throw new Error('Por favor completa todos los campos del estudiante');
          }

          document.getElementById('progressText').textContent = 'üë§ Creando nuevo estudiante...';
          
          const studentRes = await fetch(`${API_URL}/api/uploads/students`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(studentData),
          });

          if (!studentRes.ok) {
            const errorData = await studentRes.json();
            throw new Error(errorData.message || 'Error creando estudiante');
          }

          const newStudent = await studentRes.json();
          studentId = newStudent.id;
          console.log('üë§ Estudiante creado:', newStudent);
        } else {
          studentId = document.getElementById('studentId').value;
          if (!studentId) {
            throw new Error('Por favor selecciona un estudiante');
          }
        }

        // Paso 1: Subir archivo
        activateStep(1);
        document.getElementById('progressText').textContent = 'üì§ Subiendo archivo...';
        const formData = new FormData();
        formData.append('file', file);

        const uploadRes = await fetch(`${API_URL}/api/uploads/reports/${studentId}`, {
          method: 'POST',
          body: formData,
        });

        if (!uploadRes.ok) {
          const errorData = await uploadRes.json();
          throw new Error(errorData.message || 'Error subiendo archivo');
        }

        const report = await uploadRes.json();
        console.log('üì§ Archivo subido:', report);
        completeStep(1);

        // Paso 2 y 3: Extraer texto y analizar
        activateStep(2);
        document.getElementById('progressText').textContent = 'üìÑ Extrayendo texto...';
        await sleep(1000);
        completeStep(2);
        
        activateStep(3);
        document.getElementById('progressText').textContent = 'ü§ñ Analizando con Claude AI...';
        await sleep(500);
        completeStep(3);

        // Paso 4: Generar PEI
        activateStep(4);
        document.getElementById('progressText').textContent = 'üìã Generando PEI personalizado...';
        const peiRes = await fetch(`${API_URL}/api/peis/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reportId: report.id }),
        });

        if (!peiRes.ok) {
          const errorData = await peiRes.json();
          throw new Error(errorData.message || 'Error generando PEI');
        }

        const pei = await peiRes.json();
        console.log('üìã PEI generado:', pei);
        completeStep(4);

        // Paso 5: Disparar workflow
        activateStep(5);
        document.getElementById('progressText').textContent = 'üìß Enviando notificaciones...';
        try {
          await fetch(`${API_URL}/api/n8n/pei/${pei.id}/generated`, {
            method: 'POST',
          });
        } catch (workflowError) {
          console.warn('‚ö†Ô∏è Workflow n8n fall√≥, pero PEI generado correctamente');
        }
        completeStep(5);

        // Mostrar resultado
        progress.classList.remove('show');
        result.classList.add('show');
        document.getElementById('peiId').textContent = pei.id;
        document.getElementById('studentName').textContent = 
          `${pei.student.name} ${pei.student.lastName}`;
        document.getElementById('peiStatus').textContent = pei.status;
        document.getElementById('peiVersion').textContent = pei.version;

      } catch (err) {
        console.error('‚ùå Error:', err);
        progress.classList.remove('show');
        showError(err.message);
      }
    });

    function activateStep(stepNumber) {
      const step = document.getElementById(`step${stepNumber}`);
      step.classList.add('active');
    }

    function completeStep(stepNumber) {
      const step = document.getElementById(`step${stepNumber}`);
      step.classList.remove('active');
      step.classList.add('done');
      step.querySelector('.step-icon').textContent = '‚úÖ';
    }

    function showError(message) {
      const error = document.getElementById('error');
      const form = document.getElementById('uploadForm');
      document.getElementById('errorMessage').textContent = message;
      error.classList.add('show');
      form.style.display = 'block';
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
  </script>
</body>
</html>
